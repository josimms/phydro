---
title: "TRY Data"
author: "YSSP"
date: "2023-05-27"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(rphydro)
library(tidyverse)
library(ggplot2)
library(reshape2)
library(gridExtra)
library(tibble)
library(dplyr)
library(purrr)
library(ggtext)
```

## Simulations
```{r}
kphio = 0.087;       # quantum yield efficiency
ppfd = 300;          # umol/m2/s
ppfd_max = 1200;
vpd  = 1000;         # Pa
co2  = 400;          # ppm
elv  = 0;            # m.a.s.l.
fapar = 0.7;         # fraction
rdark = 0.015;
tc = 25;
vwind = 3;
netrad = ppfd/2
psi_soil = -0.05
pa = calc_patm(elv)
nitrogen = 0.02 # TODO: this isn't doing anything at the moment

### New parameters
  # a_jmax is an estimated value
  # From the literature a_jmax is just a linear fitting of data rather than parameter that can be explicitly found
  # 
  # micro mols m-2 s-2 (g m-2)-1
a_jmax = 50 # Units

par_cost = list(alpha=0.1, gamma=1, carbon_allocation = 1);
par_plant = list(conductivity=3e-17, psi50=-2, b=2);
options = list(gs_method = "GS_IGF", 
               et_method = "ET_DIFFUSION",
               ftemp_vj_method = "FV_kumarathunge19",
               ftemp_rd_method = "FR_heskel16",
               ftemp_br_method = "FB_atkin15",
               scale_alpha = F)

allocation = 1.0
dat = tibble(ppfd = seq(1,1200,length.out=50)) %>% mutate(dat = purrr::map(.x=ppfd, .f = ~rphydro_nitrogen(tc, tc, .x, netrad, vpd, co2, pa, nitrogen, fapar, kphio, psi_soil, rdark, vwind, a_jmax, par_plant, list(alpha=0.1, gamma=1, carbon_allocation = allocation), options))) %>% unnest_wider(dat)

allocation = 2.0
dat_2 = tibble(ppfd = seq(1,1200,length.out=50)) %>% mutate(dat = purrr::map(.x=ppfd, .f = ~rphydro_nitrogen(tc, tc, .x, netrad, vpd, co2, pa, nitrogen, fapar, kphio, psi_soil, rdark, vwind, a_jmax, par_plant, list(alpha=0.1, gamma=1, carbon_allocation = allocation), options))) %>% unnest_wider(dat)

allocation = 1.5
dat_1.5 = tibble(ppfd = seq(1,1200,length.out=50)) %>% mutate(dat = purrr::map(.x=ppfd, .f = ~rphydro_nitrogen(tc, tc, .x, netrad, vpd, co2, pa, nitrogen, fapar, kphio, psi_soil, rdark, vwind, a_jmax, par_plant, list(alpha=0.1, gamma=1, carbon_allocation = allocation), options))) %>% unnest_wider(dat)

allocation = 0.75
dat_0.75 = tibble(ppfd = seq(1,1200,length.out=50)) %>% mutate(dat = purrr::map(.x=ppfd, .f = ~rphydro_nitrogen(tc, tc, .x, netrad, vpd, co2, pa, nitrogen, fapar, kphio, psi_soil, rdark, vwind, a_jmax, par_plant, list(alpha=0.1, gamma=1, carbon_allocation = allocation), options))) %>% unnest_wider(dat)

dat_original = tibble(ppfd = seq(1,1200,length.out=50)) %>% mutate(dat = purrr::map(.x=ppfd, .f = ~rphydro_numerical(tc, tc, .x, netrad, vpd, co2, pa, fapar, kphio, psi_soil, rdark, vwind, par_plant, par_cost, options))) %>% unnest_wider(dat)
```

## Water changed

```{r}
# Define ranges for PPFD and VPD
ppfd_values <- seq(300, 1200, length.out = 50)  # 50 steps from 300 to 1200 umol/m2/s
vpd_values <- seq(1, 2000, length.out = 50)     # 50 steps from 1 to 2000 Pa
allocation_values <- c(0.75, 1.0, 1.5, 2.0)     # Allocation values

# Create a data frame to store all combinations of PPFD, VPD, and allocation
combinations <- expand.grid(ppfd = ppfd_values, vpd = vpd_values, allocation = allocation_values)

# Define the function to run the model with error handling
run_model_safe <- function(ppfd, vpd, allocation) {
  tryCatch({
    netrad <- ppfd / 2  # Update net radiation with new PPFD
    dat <- rphydro_nitrogen(tc, tc, ppfd, netrad, vpd, co2, pa, nitrogen, fapar, kphio, 
                            psi_soil, rdark, vwind, a_jmax, par_plant, 
                            list(alpha=0.1, gamma=1, carbon_allocation = allocation), options)
    return(dat)
  }, error = function(e) {
    warning(paste("Error in model at ppfd =", ppfd, ", vpd =", vpd, ", allocation =", allocation))
    # Return a named list with NA values
    return(list(A_net = NA, gsw = NA, ci = NA, other_output1 = NA, other_output2 = NA))  # Adjust based on your model's output structure
  })
}

# Apply the model to each row of the combinations data frame
results <- combinations %>%
  rowwise() %>%
  mutate(model_output = list(run_model_safe(ppfd, vpd, allocation))) %>%
  unnest_wider(model_output)

results <- results %>%
  mutate(allocation = factor(allocation, levels = c(2.0, 1.5, 1.0, 0.75)))

```


## TRY Data 

```{r}
###
# Read in the data
###
direct = "/home/josimms/Documents/Austria/TRY_data/"
data_try_jmax <- data.table::fread(paste0(direct, "35495.txt"))
data_try_vcmax <- data.table::fread(paste0(direct, "35516.txt"))
data_try_leaf_n <- data.table::fread(paste0(direct, "35525.txt"))
# Clean up the DataName column

# Combine the data searches
data_try <- rbind(data_try_jmax, data_try_vcmax)
data_try <- rbind(data_try, data_try_leaf_n)

data_try$ValuesFromString <-  as.numeric(iconv(data_try$OrigValueStr, to = "ASCII//TRANSLIT", sub = "NA"))

###
# Units should be changed into %
###
get_response_description(data_try, "Leaf nitrogen content per area (Narea)")
get_response_description(data_try, "Leaf nitrogen content per dry mass (Nmass)")

###
# Boreal forest data
###
data_try_boreal <- data_try[data_try$DataName == 'Vegetation type / Biome' & data_try$OrigValueStr %in% c('Boreal'),]
data_try_scots_pine <- data_try_boreal[data_try_boreal$AccSpeciesName == "Pinus sylvestris",]

boreal_pivot_std <- data_try_boreal %>%
    dplyr::mutate(DataName = stringi::stri_trans_general(DataName, "Latin-ASCII")) %>%
    tidyr::pivot_wider(names_from = DataName, 
                       values_from = StdValue, 
                       id_cols = ObservationID, 
                       values_fn = ~mean(.x, na.rn = T))

boreal_pivot_sting <- data_try_boreal %>%
  dplyr::mutate(DataName = stringi::stri_trans_general(DataName, "Latin-ASCII")) %>%
  tidyr::pivot_wider(names_from = DataName, 
                     values_from = ValuesFromString, 
                     id_cols = ObservationID, 
                     values_fn = ~mean(.x, na.rn = T))

scots_pine_pivot_std_all_cols <- data_try %>%
  dplyr::mutate(DataName = stringi::stri_trans_general(DataName, "Latin-ASCII")) %>%
  tidyr::pivot_wider(names_from = DataName, 
                     values_from = StdValue, 
                     id_cols = ObservationID, 
                     values_fn = ~mean(.x, na.rm = TRUE))
  
# TODO: make this not crash!
scots_pine_pivot_std_all_cols %>%  
  dplyr::left_join(data_try %>% 
                     dplyr::select(ObservationID, AccSpeciesName), 
                   by = "ObservationID")

scots_pine_pivot_string_all_cols <- data_try %>%
  dplyr::mutate(DataName = stringi::stri_trans_general(DataName, "Latin-ASCII")) %>%
  tidyr::pivot_wider(names_from = DataName, 
                     values_from = ValuesFromString, 
                     id_cols = ObservationID, 
                     values_fn = ~mean(.x, na.rn = T))

check_var_combinations(names(out_data_try_pivot)[-1], out_data_try_pivot)

column_names <- c(
    "Leaf maintenance respiration, nitrogen basis, at the given temperature",
    "Leaf respiration (growing tissue), nitrogen basis, at the given temperature",
    "Ratio of root nitrogen content per dry mass to foliage nitrogen content per dry mass",
    "Leaf nitrogen content per dry mass (Nmass)",
    "Photosynthetic carboxylation capacity (Vcmax, Vmax) per leaf dry mass at ambient temperature",
    "Jmax per dry mass at ambient or leaf temperature",
    "Photosynthetic carboxylation capacity (Vcmax, Vmax) per leaf dry mass at 25 C",
    "Photosynthetic electron transport capacity per leaf dry mass at 25C (Jmax25mass)",
    "Leaf N content per dry mass (one year old leaves)",
    "Leaf nitrogen content per dry mass (old leaves)",
    "Leaf organic nitrogen content per dry mass",
    "Leaf carbocylation capacity (Vcmax) at 25C per leaf area, based on local temperature dependence (Rogers_2017)",
    "Photosynthetic carboxylation capacity (Vcmax, Vmax) per leaf area at leaf temperature",
    "Photosynthetic carboxylation capacity (Vcmax, Vmax) per leaf area at 25 C",
    "Photosynthetic electron transport capacity per leaf area at 25C (Jmax25area)",
    "Jmax per leaf area at ambient or leaf temperature",
    "Potential electron transport rate, on a projected area basis",
    "Leaf nitrogen content per area (Narea)",
    "Soil N; available N per ground area",
    "Soil N: available N",
    "Soil N content per ground area",
    "Soil nitrogen content per soil dry mass",
    "Fine root dry mass per ground area",
    "Belowground plant organ dry mass to leaf dry mass ratio",
    "Net primary productivity of the site (NPP)"
  )

###
# Selected columns
###

scots_pine_colums_std <- scots_pine_pivot_std_all_cols[,column_names]
scots_pine_colums_string <- scots_pine_pivot_string_all_cols[,column_names]

```

## Jmax and Vcmax

```{r}
# Create the plot

get_response_description(data_try,
                         "Photosynthetic electron transport capacity per leaf area at 25C (Jmax25area)")
get_response_description(data_try,
                         "Jmax per leaf area at ambient or leaf temperature")
get_response_description(data_try,
                         "Photosynthetic carboxylation capacity (Vcmax, Vmax) per leaf area at 25 C")
get_response_description(data_try,
                         "Photosynthetic carboxylation capacity (Vcmax, Vmax) per leaf area at 25 C")

ggplot() +
  #geom_point(data = scots_pine_colums_std, aes(x = `Jmax per leaf area at ambient or leaf temperature`,
  #                                           y = `Photosynthetic carboxylation capacity (Vcmax, Vmax) per leaf area at leaf temperature`,
  #                                             shape = "Ambient"), col = "darkgrey") +
  geom_point(data = scots_pine_colums_std, aes(x = `Photosynthetic electron transport capacity per leaf area at 25C (Jmax25area)`,
                                               y = `Photosynthetic carboxylation capacity (Vcmax, Vmax) per leaf area at 25 C`,
                                               shape = "25°C"), col = '') +
  labs(y = "Vcmax, micro mol m-2 s-1", x = "Jmax, micro mol m-2 s-1") + 
  geom_point(data = results, aes(y = vcmax25, x = jmax25, color = allocation), size = 2) +
  theme_minimal() +
  theme(strip.background = element_rect(color = "white", size = 1),
        legend.position = "right") +
  scale_color_manual(values = c("1" = "green", "0.75" = "darkgreen", "1.5" = "yellow", "2" = "red")) +
  scale_shape_manual(values = c("Ambient" = 16, "25°C" = 17)) +
  guides(color = guide_legend(title = "Infrastructure Belowground"),
         shape = guide_legend(title = "Temperature"))
```

## Jmax and leaf N ratio

```{r}
get_response_description(data_try,
                         "Leaf nitrogen content per dry mass (Nmass)")

# Calculate gradients (this should be done outside the ggplot function)
calc_gradient <- function(data, x_col, y_col) {
  model <- lm(data[[y_col]] ~ 0 + data[[x_col]])
  return(round(coef(model)[1], 2))
}

gradient_0.75 <- calc_gradient(dat_0.75, "n_leaf", "jmax")
gradient_1 <- calc_gradient(dat, "n_leaf", "jmax")
gradient_1.5 <- calc_gradient(dat_1.5, "n_leaf", "jmax")
gradient_2 <- calc_gradient(dat_2, "n_leaf", "jmax")

gradient_ambient <- calc_gradient(scots_pine_colums_std, 
                                  "Leaf nitrogen content per area (Narea)", 
                                  "Jmax per leaf area at ambient or leaf temperature")
gradient_25C <- calc_gradient(scots_pine_colums_std, 
                              "Leaf nitrogen content per area (Narea)", 
                              "Photosynthetic electron transport capacity per leaf area at 25C (Jmax25area)")

# Create colored subtitle
create_colored_text <- function(label, value, color) {
  return(paste0("<span style='color:", color, "'>", label, " = ", value, "</span>"))
}

subtitle <- paste(
  create_colored_text("Ambient", gradient_ambient, "darkgrey"),
  create_colored_text("25°C", gradient_25C, "black"),
  create_colored_text("Infrastructure, 0.75", gradient_0.75, "darkgreen"),
  create_colored_text("Infrastructure, 1", gradient_1, "green"),
  create_colored_text("Infrastructure, 1.5", gradient_1.5, "yellow"),
  create_colored_text("Infrastructure, 2", gradient_2, "red"),
  sep = " | "
)

# Now, the ggplot code
p <- ggplot() +
  geom_point(data = scots_pine_colums_std, aes(x = `Leaf nitrogen content per area (Narea)`,
                                             y = `Jmax per leaf area at ambient or leaf temperature`,
                                               color = "Ambient Temperature"), shape = 16) +
  geom_smooth(data = scots_pine_colums_std, aes(x = `Leaf nitrogen content per area (Narea)`,
                                             y = `Jmax per leaf area at ambient or leaf temperature`,
                                             color = "Ambient Temperature"), 
              method = "lm", formula = y ~ 0 + x, se = FALSE, linetype = "dashed") +
  geom_point(data = scots_pine_colums_std, aes(x = `Leaf nitrogen content per area (Narea)`,
                                               y = `Photosynthetic electron transport capacity per leaf area at 25C (Jmax25area)`,
                                               color = "25°C"), shape = 16) +
  geom_smooth(data = scots_pine_colums_std, aes(x = `Leaf nitrogen content per area (Narea)`,
                                               y = `Photosynthetic electron transport capacity per leaf area at 25C (Jmax25area)`,
                                               color = "25°C"), 
              method = "lm", formula = y ~ 0 + x, se = FALSE, linetype = "dashed") +
  labs(x = "N per leaf (g m-2)",
       y = "Jmax, micro mol m-2 s-1",
       title = "Gradients") +
  geom_line(data = dat_2, aes(y = jmax25, x = n_leaf, color = "Infrastructure = 2"), size = 1.2) +
  geom_line(data = dat_1.5, aes(y = jmax25, x = n_leaf, color = "Infrastructure = 1.5"), size = 1.2) +
  geom_line(data = dat, aes(y = jmax25, x = n_leaf, color = "Infrastructure = 1"), size = 1.2) +
  geom_line(data = dat_0.75, aes(y = jmax25, x = n_leaf, color = "Infrastructure = 0.75"), size = 1.2) +
  scale_color_manual(name = "Lines", 
                     values = c("Ambient Temperature" = "darkgrey",
                                "25°C" = "black",
                                "Infrastructure = 0.75" = "darkgreen",
                                "Infrastructure = 1" = "green",
                                "Infrastructure = 1.5" = "yellow",
                                "Infrastructure = 2" = "red")) +
  theme_minimal() +
  theme(strip.background = element_rect(color = "white", size = 1),
        legend.position = "right",
        plot.title = element_text(hjust = 0.5)) +
  coord_cartesian(xlim = c(0, 10))  # This line sets the x-axis limits from 0 to 10

# Create a text grob for the subtitle
subtitle_grob <- grid::textGrob(subtitle, gp = grid::gpar(fontsize = 8))

p <- p + 
  labs(subtitle = subtitle) +
  theme(
    plot.subtitle = element_markdown(hjust = 0.5, size = 8)
  )

# Now just plot p directly, no need for grid.arrange
print(p)
```
## Vcmax and leaf C/N ratio

```{r}

ggplot() +
  geom_point(data = scots_pine_colums_std, aes(x = `Leaf nitrogen content per area (Narea)`,
                                               y = `Photosynthetic carboxylation capacity (Vcmax, Vmax) per leaf area at leaf temperature`,
                                               shape = "Ambient"), col = "darkgrey") +
  geom_point(data = scots_pine_colums_std, aes(x = `Leaf nitrogen content per area (Narea)`,
                                               y = `Photosynthetic carboxylation capacity (Vcmax, Vmax) per leaf area at 25 C`,
                                               shape = "25°C"), col = "black") +
  labs(x = "N per leaf (g m-2)",
       y = "Vcmax, micro mol m-2 s-1") +
  geom_point(data = results, aes(y = vcmax25, x = n_leaf, color = allocation), size = 2, shape = 4) +
  theme_minimal() +
  theme(strip.background = element_rect(color = "white", size = 1),
        legend.position = "right") +
  coord_cartesian(xlim = c(0, 17), ylim = c(0, 400)) +
  scale_color_manual(values = c("1" = "green", "0.75" = "darkgreen", "1.5" = "yellow", "2" = "red")) +
  scale_shape_manual(values = c("Ambient" = 16, "25°C" = 17)) +
  guides(color = guide_legend(title = "Infrastructure Belowground"),
         shape = guide_legend(title = "Temperature"))

```

## Environmental controls

```{r}

library(ggplot2)
library(patchwork)

# First plot
plot1 <- ggplot(results[results$allocation == 1, ], aes(y = vcmax25, x = n_leaf)) +
  geom_point(aes(color = ppfd, shape = factor(allocation)), size = 2) +
  scale_color_gradient(low = "blue", high = "red", name = "PPFD (umol/m2/s)") +
  scale_shape_manual(values = c(16), name = "Infrastructure", labels = c("1.0")) +
  labs(x = "N per leaf (g m-2)", y = "Vcmax, micro mol m-2 s-1") +
  theme_minimal() +
  theme(strip.background = element_rect(color = "white", size = 1),
        legend.title = element_text(),  # Ensure legend titles are displayed
        legend.position = "right")

# Second plot
plot2 <- ggplot(results[results$allocation == 1, ], aes(y = vcmax25, x = n_leaf)) +
  geom_point(aes(color = vpd, shape = factor(allocation)), size = 2) +
  scale_color_gradient(low = "blue", high = "red", name = "VPD") +
  scale_shape_manual(values = c(16), name = "Infrastructure", labels = c("1.0")) +
  labs(x = "N per leaf (g m-2)", y = "Vcmax, micro mol m-2 s-1") +
  theme_minimal() +
  theme(strip.background = element_rect(color = "white", size = 1),
        legend.title = element_text(),  # Ensure legend titles are displayed
        legend.position = "right")

# Combine plots side by side
combined_plot <- plot1 + plot2
combined_plot



```

## Soil N

```{r}

plot(scots_pine_colums_std$`Soil N content per ground area`)

ggplot() +
  geom_point(data = data_try, aes(x = `Jmax per leaf area at ambient or leaf temperature`,
                                  y = `Photosynthetic carboxylation capacity (Vcmax, Vmax) per leaf area at leaf temperature`,
                                               linetype = "Area, Ambient Temperature"), col = "darkgrey")
  


```


## N max and N area

```{r}

# TODO: Should I add a line here?

ggplot() +
  geom_point(data = scots_pine_colums_std, aes(x = `Leaf nitrogen content per area (Narea)`,
                                               y = `Leaf nitrogen content per dry mass (Nmass)`,
                                               linetype = "Area, 25'C"), col = "black") +
  labs(x = "N per leaf area",
       y = "N per leaf mass")
```



