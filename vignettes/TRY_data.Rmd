---
title: "TRY Data"
author: "YSSP"
date: "2023-05-27"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(rphydro)
library(broom)
library(tidyverse)
library(ggplot2)
library(reshape2)
library(gridExtra)
library(tibble)
library(dbplyr)
library(dplyr)
library(tidyr)
library(purrr)
library(ggtext)
library(ggplot2)
library(patchwork)
library(scales)
```

## Simulations
```{r}
kphio = 0.087;       # quantum yield efficiency
ppfd = 300;          # umol/m2/s
ppfd_max = 1200;
vpd  = 1000;         # Pa
co2  = 400;          # ppm
elv  = 0;            # m.a.s.l.
fapar = 0.7;         # fraction
rdark = 0.015;
tc = 25;
vwind = 3;
netrad = ppfd/2
psi_soil = -0.05
pa = calc_patm(elv)
nitrogen = 1

### New parameters
  # a_jmax is an estimated value
  # From the literature a_jmax is just a linear fitting of data rather than parameter that can be explicitly found
  # 
  # I would like the unit to be weight of nitrogen per dry mass, rather than by area
  #
  # micro mols m-2 s-2 (mg g)-1
a_jmax = 3700

par_cost = list(alpha=0.1, gamma=1, root_cost_per_zeta = 1);
par_plant = list(conductivity=3e-17, psi50=-2, b=2);
options = list(gs_method = "GS_IGF", 
               et_method = "ET_DIFFUSION",
               ftemp_vj_method = "FV_kumarathunge19",
               ftemp_rd_method = "FR_heskel16",
               ftemp_br_method = "FB_atkin15",
               scale_alpha = F)

allocation = 1.0/0.2
dat = tibble(ppfd = seq(1,1200,length.out=50)) %>% mutate(dat = purrr::map(.x=ppfd, .f = ~rphydro_nitrogen(tc, tc, .x, netrad, vpd, co2, pa, nitrogen, fapar, kphio, psi_soil, rdark, vwind, a_jmax, par_plant, list(alpha=0.1, gamma=1, root_cost_per_zeta = allocation), options))) %>% unnest_wider(dat)

allocation = 2.0/0.2
dat_2 = tibble(ppfd = seq(1,1200,length.out=50)) %>% mutate(dat = purrr::map(.x=ppfd, .f = ~rphydro_nitrogen(tc, tc, .x, netrad, vpd, co2, pa, nitrogen, fapar, kphio, psi_soil, rdark, vwind, a_jmax, par_plant, list(alpha=0.1, gamma=1, root_cost_per_zeta = allocation), options))) %>% unnest_wider(dat)

allocation = 1.5/0.2
dat_1.5 = tibble(ppfd = seq(1,1200,length.out=50)) %>% mutate(dat = purrr::map(.x=ppfd, .f = ~rphydro_nitrogen(tc, tc, .x, netrad, vpd, co2, pa, nitrogen, fapar, kphio, psi_soil, rdark, vwind, a_jmax, par_plant, list(alpha=0.1, gamma=1, root_cost_per_zeta = allocation), options))) %>% unnest_wider(dat)

allocation = 0.75/0.2
dat_0.75 = tibble(ppfd = seq(1,1200,length.out=50)) %>% mutate(dat = purrr::map(.x=ppfd, .f = ~rphydro_nitrogen(tc, tc, .x, netrad, vpd, co2, pa, nitrogen, fapar, kphio, psi_soil, rdark, vwind, a_jmax, par_plant, list(alpha=0.1, gamma=1, root_cost_per_zeta = allocation), options))) %>% unnest_wider(dat)

dat_original = tibble(ppfd = seq(1,1200,length.out=50)) %>% mutate(dat = purrr::map(.x=ppfd, .f = ~rphydro_numerical(tc, tc, .x, netrad, vpd, co2, pa, fapar, kphio, psi_soil, rdark, vwind, par_plant, par_cost, options))) %>% unnest_wider(dat)
```

## Water changed

```{r}
# Define ranges for PPFD and VPD
ppfd_values <- seq(100, 1000, length.out = 50)  # 50 steps from 300 to 1200 umol/m2/s
vpd_values <- seq(1, 30, length.out = 50)     # 50 steps from 1 to 2000 Pa
allocation_values <- c(0.75, 1.0, 1.5, 2.0)     # Allocation values

# Create a data frame to store all combinations of PPFD, VPD, and allocation
combinations <- expand.grid(ppfd = ppfd_values, vpd = vpd_values, allocation = allocation_values)

# Define the function to run the model with error handling
run_model_safe <- function(ppfd, vpd, allocation) {
  tryCatch({
    netrad <- ppfd / 2  # Update net radiation with new PPFD
    dat <- rphydro_nitrogen(tc, tc, ppfd, netrad, vpd, co2, pa, nitrogen, fapar, kphio, 
                            psi_soil, rdark, vwind, a_jmax, par_plant, 
                            list(alpha=0.1, gamma=1, root_cost_per_zeta = allocation), options)
    return(dat)
  }, error = function(e) {
    warning(paste("Error in model at ppfd =", ppfd, ", vpd =", vpd, ", allocation =", allocation))
    # Return a named list with NA values
    return(list(A_net = NA, gsw = NA, ci = NA, other_output1 = NA, other_output2 = NA))  # Adjust based on your model's output structure
  })
}

# Apply the model to each row of the combinations data frame
results <- combinations %>%
  rowwise() %>%
  mutate(model_output = list(run_model_safe(ppfd, vpd, allocation))) %>%
  unnest_wider(model_output)

results <- results %>%
  mutate(allocation = factor(allocation, levels = c(2.0, 1.5, 1.0, 0.75)))

```


## TRY Data 

```{r}
###
# Read in the data
###
direct = "/home/josimms/Documents/Austria/TRY_data/"
data_try_jmax <- data.table::fread(paste0(direct, "35495.txt"))
data_try_vcmax <- data.table::fread(paste0(direct, "35516.txt"))
data_try_leaf_n <- data.table::fread(paste0(direct, "35525.txt"))
# Clean up the DataName column

# Combine the data searches
data_try <- rbind(data_try_jmax, data_try_vcmax)
data_try <- rbind(data_try, data_try_leaf_n)

data_try$ValuesFromString <-  as.numeric(iconv(data_try$OrigValueStr, to = "ASCII//TRANSLIT", sub = "NA"))

###
# Units should be changed into %
###
#get_response_description(data_try, "Leaf nitrogen content per area (Narea)")
#get_response_description(data_try, "Leaf nitrogen content per dry mass (Nmass)")

###
# Boreal forest data
###
data_try_boreal <- data_try[data_try$DataName == 'Vegetation type / Biome' & data_try$OrigValueStr %in% c('Boreal'),]
data_try_scots_pine <- data_try_boreal[data_try_boreal$AccSpeciesName == "Pinus sylvestris",]

#boreal_pivot_std <- data_try_boreal %>%
#    dplyr::mutate(DataName = stringi::stri_trans_general(DataName, "Latin-ASCII")) %>%
#    tidyr::pivot_wider(names_from = DataName, 
#                       values_from = StdValue, 
#                       id_cols = ObservationID, 
#                       values_fn = ~mean(.x, na.rn = T))

#boreal_pivot_sting <- data_try_boreal %>%
#  dplyr::mutate(DataName = stringi::stri_trans_general(DataName, "Latin-ASCII")) %>%
#  tidyr::pivot_wider(names_from = DataName, 
#                     values_from = ValuesFromString, 
#                    id_cols = ObservationID, 
#                     values_fn = ~mean(.x, na.rn = T))

#scots_pine_pivot_std_all_cols <- data_try_scots_pine %>%
#  dplyr::mutate(DataName = stringi::stri_trans_general(DataName, "Latin-ASCII")) %>%
#  tidyr::pivot_wider(names_from = DataName, 
#                     values_from = StdValue, 
#                     id_cols = ObservationID, 
#                     values_fn = ~mean(.x, na.rm = TRUE))
  
#scots_pine_pivot_string_all_cols <- data_try_scots_pine %>%
#  dplyr::mutate(DataName = stringi::stri_trans_general(DataName, "Latin-ASCII")) %>%
#  tidyr::pivot_wider(names_from = DataName, 
#                     values_from = ValuesFromString, 
#                     id_cols = ObservationID, 
#                     values_fn = ~mean(.x, na.rn = T))

pivot_std_all_cols <- data_try %>%
  dplyr::mutate(DataName = stringi::stri_trans_general(DataName, "Latin-ASCII")) %>%
  tidyr::pivot_wider(names_from = DataName, 
                     values_from = StdValue, 
                     id_cols = c(ObservationID, SpeciesName),
                     values_fn = ~mean(.x, na.rm = TRUE))

# check_var_combinations(names(out_data_try_pivot)[-1], out_data_try_pivot)

column_names <- c(
    "ObservationID",
    "SpeciesName",
    "Leaf maintenance respiration, nitrogen basis, at the given temperature",
    "Leaf respiration (growing tissue), nitrogen basis, at the given temperature",
    "Ratio of root nitrogen content per dry mass to foliage nitrogen content per dry mass",
    "Leaf nitrogen content per dry mass (Nmass)",
    "Photosynthetic carboxylation capacity (Vcmax, Vmax) per leaf dry mass at ambient temperature",
    "Photosynthetic carboxylation capacity (Vcmax, Vmax) per leaf dry mass at 25 C",
    "Photosynthetic electron transport capacity per leaf dry mass at 25C (Jmax25mass)",
    "Leaf N content per dry mass (one year old leaves)",
    "Leaf nitrogen content per dry mass (old leaves)",
    "Leaf organic nitrogen content per dry mass",
    "Leaf carbocylation capacity (Vcmax) at 25C per leaf area, based on local temperature dependence (Rogers_2017)",
    "Photosynthetic carboxylation capacity (Vcmax, Vmax) per leaf area at leaf temperature",
    "Photosynthetic carboxylation capacity (Vcmax, Vmax) per leaf area at 25 C",
    "Photosynthetic electron transport capacity per leaf area at 25C (Jmax25area)",
    "Jmax per dry mass at ambient or leaf temperature",
    "Potential electron transport rate, on a projected area basis",
    "Leaf nitrogen content per area (Narea)",
    "Soil N; available N per ground area",
    "Soil N: available N",
    "Soil N content per ground area",
    "Soil nitrogen content per soil dry mass",
    "Fine root dry mass per ground area",
    "Belowground plant organ dry mass to leaf dry mass ratio",
    "Net primary productivity of the site (NPP)"
  )

###
# Selected columns
###

scots_pine_colums_std <- pivot_std_all_cols[,column_names]
# scots_pine_colums_string <- pivot_std_all_cols[,column_names]

colums_std <- pivot_std_all_cols[,column_names]

# Make the species column sensible
colums_std$SpeciesName[colums_std$SpeciesName %in% c("", "-", "??")] <- NA
colums_std$SpeciesName <- iconv(colums_std$SpeciesName, to = "ASCII", sub = "")
colums_std$SpeciesName[unlist(lapply(colums_std$SpeciesName, startsWith, "?"))] <- NA
sum(grepl("[^A-Za-z0-9 ]", unique(colums_std$SpeciesName)))
```

## Mesi data

```{r}

mesi_path = "/home/josimms/Documents/Austria/MESI_data/data"
  
a <- lapply(list.files(mesi_path, pattern = "mesi", full.names = TRUE), data.table::fread)
names(a) <- gsub(".csv", "", list.files(mesi_path, pattern = "mesi"))

a$mesi_main <- a$mesi_main %>%
  group_by(db, citation, site, study, lat, lon, elevation, ecosystem_type, vegetation_type) %>%
  mutate(index = cur_group_id()) %>%
  ungroup()

convert_nitrogen_to_g_g <- function(value, unit) {
    # Molar mass of nitrogen in g/mol
    molar_mass_nitrogen <- 14.01
    
    # Define a list of conversion factors for nitrogen per leaf mass
    conversion_factors <- list(
      "g_100g" = 1 / 100,            # grams per 100 grams to grams per gram
      "g_kg" = 1 / 1000,             # grams per kilogram to grams per gram
      "ug_mg" = 1 / 1000,            # micrograms per milligram to grams per gram
      "mg_g" = 1 / 1000,             # milligrams per gram to grams per gram
      "mg_kg" = 1 / 1e6,             # milligrams per kilogram to grams per gram
      "mgn_g" = 1 / 1000,            # milligrams of nitrogen per gram to grams per gram
      "g_g" = 1,                     # grams per gram (no conversion needed)
      "mmol_g" = molar_mass_nitrogen / 1000,  # millimoles of nitrogen per gram to grams per gram
      "umol_g" = molar_mass_nitrogen / 1e6    # micromoles of nitrogen per gram to grams per gram
    )
    
    # Check if the unit is in the list of known conversions
    if (unit %in% names(conversion_factors)) {
      factor <- conversion_factors[[unit]]
      return(value * factor)
    } else {
      # There are other units here, so don't need to convert the ones that are not in the list!
      return(value)
    }
  }
  
  # Add a new column 'x_corrected' based on the 'x_c' values and corresponding units
  a$mesi_main$x_corrected <- mapply(function(value, unit) {
    tryCatch({
      # Apply the conversion function for nitrogen per leaf mass
      convert_nitrogen_to_g_g(value, unit)
    }, error = function(e) {
      NA  # If there's an error (e.g., unknown unit), set value as NA
    })
  }, a$mesi_main$x_c, a$mesi_main$x_units)

# Transform the data so the response variables are columns
MESI_df <- a$mesi_main %>%
  pivot_wider(names_from = response, values_from = x_corrected, id_cols = c(index, dominant_species), values_fn = function(x) {mean(x, na.rm = T)})
MESI_df <- MESI_df[!is.na(MESI_df$dominant_species),]
```

## Jmax and Vcmax

```{r}
# Create the plot

#get_response_description(data_try,
#                         "Photosynthetic electron transport capacity per leaf dry mass at 25C (Jmax25mass)")
#get_response_description(data_try,
#                         "Photosynthetic electron transport capacity per leaf area at 25C (Jmax25area)")
#get_response_description(data_try,
#                         "Photosynthetic carboxylation capacity (Vcmax, Vmax) per leaf area at leaf temperature")
#get_response_description(data_try,
#                         "Photosynthetic carboxylation capacity (Vcmax, Vmax) per leaf dry mass at 25 C")

#summary(colums_std[,c("Photosynthetic electron transport capacity per leaf dry mass at 25C (Jmax25mass)", 
#                      "Photosynthetic electron transport capacity per leaf area at 25C (Jmax25area)",
#                      "Photosynthetic carboxylation capacity (Vcmax, Vmax) per leaf area at 25 C",
#                      "Photosynthetic carboxylation capacity (Vcmax, Vmax) per leaf dry mass at 25 C")])

# First, let's create a combined color palette
all_colors <- c("1" = "green", "0.75" = "darkgreen", "1.5" = "yellow", "2" = "red")
species_colors <- scales::hue_pal()(length(unique(colums_std$SpeciesName)))
names(species_colors) <- unique(colums_std$SpeciesName)
all_colors <- c(all_colors, species_colors)

ggplot() +
  # Plot for colums_std dataset (TRY database)
  geom_point(data = colums_std[nrow(colums_std):1,], aes(x = `Photosynthetic electron transport capacity per leaf area at 25C (Jmax25area)`,
                                    y = `Photosynthetic carboxylation capacity (Vcmax, Vmax) per leaf area at 25 C`,
                                    shape = "TRY",
                                    color = "grey"), 
             size = 1, alpha = 0.5) +
  # Results
  geom_point(data = results[nrow(results):1,], aes(y = vcmax25, x = jmax25, color = allocation), size = 1) +
  # Plot for MESI_df dataset
  geom_point(data = MESI_df, aes(x = jmax, y = vcmax, shape = "MESI"), 
             color = "black", size = 2, alpha = 0.5) +
  labs(y = "Vcmax, micro mol m-2 s-1", x = "Jmax, micro mol m-2 s-1") + 
  theme_minimal() +
  theme(strip.background = element_rect(color = "white", size = 1),
        legend.position = "right") +
  scale_shape_manual(values = c("TRY" = 16, "MESI" = 17)) +
  scale_color_manual(values = all_colors, breaks = c("1", "0.75", "1.5", "2")) +
  guides(color = guide_legend(title = "Infrastructure Belowground", override.aes = list(size = 1)),
         shape = guide_legend(title = "Dataset"))

```

## Jmax and leaf N ratio

```{r}
#get_response_description(data_try,
#                         "Leaf nitrogen content per dry mass (Nmass)")
#get_response_description(data_try,
#                         "Leaf nitrogen content per area (Narea)")

# Calculate gradients (this should be done outside the ggplot function)
calc_gradient <- function(data, x_col, y_col, TRY = FALSE) {
  if (TRY) {
    data[[x_col]] = data[[x_col]]/1000
    model <- lm(data[[y_col]] ~ 0 + data[[x_col]])
  } else {
    model <- lm(data[[y_col]] ~ 0 + data[[x_col]])
  }
  
  return(round(coef(model)[1], 2))
}

gradient_0.75 <- calc_gradient(dat_0.75, "n_leaf", "jmax")
gradient_1 <- calc_gradient(dat, "n_leaf", "jmax")
gradient_1.5 <- calc_gradient(dat_1.5, "n_leaf", "jmax")
gradient_2 <- calc_gradient(dat_2, "n_leaf", "jmax")

gradient_25C <- calc_gradient(scots_pine_colums_std, 
                              "Leaf nitrogen content per dry mass (Nmass)", 
                              "Photosynthetic electron transport capacity per leaf area at 25C (Jmax25area)",
                              TRUE)
gradient_MESI <- calc_gradient(MESI_df, 
                              "leaf_n_mass", 
                              "jmax",
                              FALSE)

# Create colored subtitle
create_colored_text <- function(label, value, color) {
  return(paste0("<span style='color:", color, "'>", label, " = ", value, "</span>"))
}

subtitle <- paste(
  create_colored_text("TRY", gradient_25C, "grey"),
  create_colored_text("MESI", gradient_MESI, "black"),
  create_colored_text("Infra, 0.75", gradient_0.75, "darkgreen"),
  create_colored_text("Infra, 1", gradient_1, "green"),
  create_colored_text("Infra, 1.5", gradient_1.5, "yellow"),
  create_colored_text("Infra, 2", gradient_2, "red"),
  sep = " | "
)

lm_results_MESI <- MESI_df %>%
  filter(!is.na(jmax), 
         !is.na(leaf_n_mass)) %>%
  group_by(dominant_species) %>%
  do({
    model <- lm(jmax ~ 0 + leaf_n_mass, data = .)
    
    # Add the tidy output of the linear model and number of observations
    data.frame(tidy(model), n_values = nrow(.))
  }) %>%
  ungroup()
  
# Now, the ggplot code
# Filter out rows with NA values before applying the linear model
lm_results <- colums_std %>%
  filter(!is.na(`Photosynthetic electron transport capacity per leaf area at 25C (Jmax25area)`), 
         !is.na(`Leaf nitrogen content per dry mass (Nmass)`)) %>%
  group_by(SpeciesName) %>%
  do({
    model <- lm(`Photosynthetic electron transport capacity per leaf area at 25C (Jmax25area)` ~ 
                  0 + I(`Leaf nitrogen content per dry mass (Nmass)`/1000), data = .)
    
    # Add the tidy output of the linear model and number of observations
    data.frame(tidy(model), n_values = nrow(.))
  }) %>%
  ungroup()

# Extract gradients (slopes), p-values, and number of observations
slopes <- lm_results %>%
  filter(term == "I(`Leaf nitrogen content per dry mass (Nmass)`/1000)") %>%
  select(SpeciesName, estimate, p.value, n_values) %>%
  rename(gradient = estimate)
slopes <- slopes[slopes$n_values >= 6,]
summary(slopes$gradient)

# Print the results
print(slopes)

# Now plot with linear interpolation for each species
p <- ggplot() +
  geom_point(data = colums_std, aes(x = `Leaf nitrogen content per dry mass (Nmass)`/1000,
                                    y = `Photosynthetic electron transport capacity per leaf area at 25C (Jmax25area)`,
                                    shape = "TRY"), color = "grey", size = 2) +
  geom_smooth(data = colums_std[colums_std$SpeciesName %in% slopes$SpeciesName,], aes(x = `Leaf nitrogen content per dry mass (Nmass)`/1000,
                                     y = `Photosynthetic electron transport capacity per leaf area at 25C (Jmax25area)`,
                                     shape = "TRY", color = SpeciesName),
              method = "lm", formula = y ~ 0 + x, se = FALSE, linetype = "dashed", size = 1) +
  geom_point(data = MESI_df, aes(x = leaf_n_mass,
                                 y = jmax,
                                 shape = "MESI"), color = "black", size = 2) +
  geom_smooth(data = MESI_df, aes(x = leaf_n_mass,
                                  y = jmax,
                                  shape = "MESI"), method = "lm", formula = y ~ 0 + x, se = FALSE,
              linetype = "dashed", color = "black", size = 1) +
  labs(x = "N per leaf (g g-1)", y = "Jmax, micro mol m-2 s-1", title = "Gradients") +
  geom_line(data = dat_2, aes(y = jmax25, x = n_leaf, color = "Infrastructure = 2"), size = 1.2) +
  geom_line(data = dat_1.5, aes(y = jmax25, x = n_leaf, color = "Infrastructure = 1.5"), size = 1.2) +
  geom_line(data = dat, aes(y = jmax25, x = n_leaf, color = "Infrastructure = 1"), size = 1.2) +
  geom_line(data = dat_0.75, aes(y = jmax25, x = n_leaf, color = "Infrastructure = 0.75"), size = 1.2) +
  scale_color_manual(name = "Lines", values = c("TRY" = "grey", "MESI" = "black",
                                                "Infrastructure = 0.75" = "darkgreen", "Infrastructure = 1" = "green",
                                                "Infrastructure = 1.5" = "yellow", "Infrastructure = 2" = "red")) +
  scale_shape_manual(name = "Data", values = c("TRY" = 16, "MESI" = 17)) +
  theme_minimal() +
  theme(strip.background = element_rect(color = "white", size = 2),
        legend.position = "right", plot.title = element_text(hjust = 0.5)) +
  coord_cartesian(xlim = c(0, 0.075)) +
  labs(subtitle = subtitle) +
  theme(plot.subtitle = element_markdown(hjust = 0.5, size = 8))

# Display the plot
print(p)
```
## Vcmax and leaf C/N ratio

```{r}
gradient_0.75 <- calc_gradient(dat_0.75, "n_leaf", "vcmax")
gradient_1 <- calc_gradient(dat, "n_leaf", "vcmax")
gradient_1.5 <- calc_gradient(dat_1.5, "n_leaf", "vcmax")
gradient_2 <- calc_gradient(dat_2, "n_leaf", "vcmax")

# Step 1: Clean and Filter Data
colums_std_clean <- colums_std %>%
  filter(!is.na(`Photosynthetic carboxylation capacity (Vcmax, Vmax) per leaf area at 25 C`),
         !is.na(`Leaf nitrogen content per dry mass (Nmass)`))

# Step 2: Linear Models for colums_std (TRY data) by SpeciesName
lm_results_colums_std <- colums_std_clean %>%
  group_by(SpeciesName) %>%
  do({
    model <- lm(`Photosynthetic carboxylation capacity (Vcmax, Vmax) per leaf area at 25 C` ~ 
                  0 + I(`Leaf nitrogen content per dry mass (Nmass)` / 1000), data = .)
    data.frame(tidy(model), n_values = nrow(.))  # Return tidy output and number of observations
  }) %>%
  ungroup()

# Extract slopes and p-values for colums_std (TRY data)
slopes_colums_std <- lm_results_colums_std %>%
  filter(term == "I(`Leaf nitrogen content per dry mass (Nmass)`/1000)") %>%
  select(SpeciesName, estimate, p.value, n_values) %>%
  rename(gradient = estimate)
slopes_colums_std <- slopes_colums_std[slopes_colums_std$n_values >= 6,]

# Step 3: Plotting the Data
p <- ggplot() +
  # Points and TRY data interpolation
  geom_point(data = colums_std_clean, aes(x = `Leaf nitrogen content per dry mass (Nmass)` / 1000,
                                          y = `Photosynthetic carboxylation capacity (Vcmax, Vmax) per leaf area at 25 C`,
                                          shape = "TRY"), color = "grey", size = 2, alpha = 0.5) +
  geom_smooth(data = colums_std_clean[colums_std_clean$SpeciesName %in% slopes_colums_std$SpeciesName,], 
              aes(x = `Leaf nitrogen content per dry mass (Nmass)` / 1000,
                  y = `Photosynthetic carboxylation capacity (Vcmax, Vmax) per leaf area at 25 C`,
                  color = SpeciesName),
              method = "lm", formula = y ~ 0 + x, se = FALSE, linetype = "dashed", size = 1, alpha = 0.5) +
  
  # MESI dataset
  geom_point(data = MESI_df, aes(x = leaf_n_mass, y = vcmax, shape = "MESI"), 
             color = "black", size = 1) +
  geom_smooth(data = MESI_df, aes(x = leaf_n_mass, y = vcmax), 
             color = "black", method = "lm", formula = y ~ 0 + x, se = FALSE, linetype = "dashed", size = 1) +
  
  # Points for the "results" dataset
  geom_point(data = results[nrow(results):1,], aes(y = vcmax25, x = n_leaf, color = allocation), size = 2, shape = 4) +
  
  # Labels and theme
  labs(x = "N per leaf (g g-1)", y = "Vcmax, micro mol m-2 s-1") +
  theme_minimal() +
  theme(strip.background = element_rect(color = "white", size = 1), legend.position = "right") +
  coord_cartesian(xlim = c(0.0, 0.075), ylim = c(0, 150)) +
  
  # Legends for color and shape
  scale_color_manual(values = c("1" = "green", "0.75" = "darkgreen", "1.5" = "yellow", "2" = "red")) +
  scale_shape_manual(values = c("TRY" = 16, "MESI" = 17)) +
  guides(color = guide_legend(title = "Infrastructure Belowground"),
         shape = guide_legend(title = "Data"))

# Display the plot
print(p)
```

## Environmental controls

```{r}
# First plot
plot1 <- ggplot(results[results$allocation == 1, ], aes(y = vcmax25, x = n_leaf)) +
  geom_point(aes(color = ppfd, shape = factor(allocation)), size = 1) +
  scale_color_gradient(low = "blue", high = "red", name = "PPFD (umol/m2/s)") +
  scale_shape_manual(values = c(16), name = "Infrastructure", labels = c("1.0")) +
  labs(x = "N per dry leaf mass (g g-1)", y = "Vcmax, micro mol m-2 s-1") +
  theme_minimal() +
  theme(strip.background = element_rect(color = "white", size = 1),
        legend.title = element_text(),  # Ensure legend titles are displayed
        legend.position = "right")

# Second plot
plot2 <- ggplot(results[results$allocation == 1, ], aes(y = vcmax25, x = n_leaf)) +
  geom_point(aes(color = vpd, shape = factor(allocation)), size = 1) +
  scale_color_gradient(low = "blue", high = "red", name = "VPD") +
  scale_shape_manual(values = c(16), name = "Infrastructure", labels = c("1.0")) +
  labs(x = "N per dry leaf mass (g g-1)", y = "Vcmax, micro mol m-2 s-1") +
  theme_minimal() +
  theme(strip.background = element_rect(color = "white", size = 1),
        legend.title = element_text(),  # Ensure legend titles are displayed
        legend.position = "right")

# Combine plots side by side
combined_plot <- plot1 + plot2
combined_plot

```


## N max and N area

```{r}

ggplot() +
  geom_point(data = colums_std, aes(x = 0.001 * `Leaf nitrogen content per dry mass (Nmass)`,
                                    y = `Leaf nitrogen content per area (Narea)`,
                                    linetype = "Area, 25'C"), col = "black") +
  labs(x = "N per leaf area (g m-2)",
       y = "N per leaf mass (g g-1)")


ggplot() +
  geom_point(data = colums_std, aes(x = 0.001 * `Leaf nitrogen content per dry mass (Nmass)`,
                                    y = `Photosynthetic electron transport capacity per leaf area at 25C (Jmax25area)`,
                                    linetype = "Area, 25'C"), col = "black")

length(names(colums_std)) = length(unique(names(colums_std)))
```



