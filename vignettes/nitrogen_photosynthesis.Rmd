---
title: "Nitrogen Updates"
author: "YSSP"
date: "2023-05-27"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(rphydro)
library(tidyverse)
library(ggplot2)
library(reshape2)
```
## Parameters

Carbon allocation was 0 for fertilised, 0.2 for unfertilised (Fransson 2024)
Original jmax = 86.02379

So set a_jmax as 800 to get the equilibrium point around 80 as an original.

Nitrogen leaf content upper limit is limited by the nitrogen store in the leaf!

```{r}
kphio = 0.087;        # quantum yield efficiency
ppfd = 300;          # umol/m2/s
ppfd_max = 1200;
vpd  = 1000;         # Pa
co2  = 400;          # ppm
elv  = 0;            # m.a.s.l.
fapar = 0.7;         # fraction
rdark = 0.015;
tc = 25;
vwind = 3;
netrad = ppfd/2
psi_soil = -0.05
pa = calc_patm(elv)
nitrogen = 1

### New parameters TODO: should work with 800!
a_jmax = 800

par_cost = list(alpha=0.1, gamma=1, carbon_allocation = 1);
par_plant = list(conductivity=3e-17, psi50=-2, b=2);
options = list(gs_method = "GS_IGF", 
               et_method = "ET_DIFFUSION",
               ftemp_vj_method = "FV_kumarathunge19",
               ftemp_rd_method = "FR_heskel16",
               ftemp_br_method = "FB_atkin15",
               scale_alpha = F)
```


## Acclimating (Weekly) Response

```{r}
allocation = 1.0
dat = tibble(ppfd = seq(1,1200,length.out=50)) %>% mutate(dat = purrr::map(.x=ppfd, .f = ~rphydro_nitrogen(tc, tc, .x, netrad, vpd, co2, pa, nitrogen, fapar, kphio, psi_soil, rdark, vwind, a_jmax, par_plant, list(alpha=0.1, gamma=1, carbon_allocation = allocation), options))) %>% unnest_wider(dat)

allocation = 2.0
dat_2 = tibble(ppfd = seq(1,1200,length.out=50)) %>% mutate(dat = purrr::map(.x=ppfd, .f = ~rphydro_nitrogen(tc, tc, .x, netrad, vpd, co2, pa, nitrogen, fapar, kphio, psi_soil, rdark, vwind, a_jmax, par_plant, list(alpha=0.1, gamma=1, carbon_allocation = allocation), options))) %>% unnest_wider(dat)

allocation = 1.5
dat_1.5 = tibble(ppfd = seq(1,1200,length.out=50)) %>% mutate(dat = purrr::map(.x=ppfd, .f = ~rphydro_nitrogen(tc, tc, .x, netrad, vpd, co2, pa, nitrogen, fapar, kphio, psi_soil, rdark, vwind, a_jmax, par_plant, list(alpha=0.1, gamma=1, carbon_allocation = allocation), options))) %>% unnest_wider(dat)

allocation = 0.75
dat_0.75 = tibble(ppfd = seq(1,1200,length.out=50)) %>% mutate(dat = purrr::map(.x=ppfd, .f = ~rphydro_nitrogen(tc, tc, .x, netrad, vpd, co2, pa, nitrogen, fapar, kphio, psi_soil, rdark, vwind, a_jmax, par_plant, list(alpha=0.1, gamma=1, carbon_allocation = allocation), options))) %>% unnest_wider(dat)

dat_original = tibble(ppfd = seq(1,1200,length.out=50)) %>% mutate(dat = purrr::map(.x=ppfd, .f = ~rphydro_numerical(tc, tc, .x, netrad, vpd, co2, pa, fapar, kphio, psi_soil, rdark, vwind, par_plant, par_cost, options))) %>% unnest_wider(dat)
```


```{r}
df <- dat %>% melt("ppfd")
df_2 <- dat_2 %>% melt("ppfd")
df_1.5 <- dat_1.5 %>% melt("ppfd")
df_0.75 <- dat_0.75 %>% melt("ppfd")
df_original.m <- dat_original %>% melt("ppfd")

ggplot() + 
  geom_line(data = df, aes(y = value, x = ppfd, color = "Nitrogen Version, Allocation = 1")) +
  geom_line(data = df_2, aes(y = value, x = ppfd, color = "Nitrogen Version, Allocation = 2")) +
  geom_line(data = df_1.5, aes(y = value, x = ppfd, color = "Nitrogen Version, Allocation = 1.5")) +
  geom_line(data = df_0.75, aes(y = value, x = ppfd, color = "Nitrogen Version, Allocation = 0.75")) +
  geom_line(data = df_original.m, aes(y = value, x = ppfd, color = "Numeric"), linetype="dotted") +
  scale_color_manual(values = c("Nitrogen Version, Allocation = 0.75" = "red",
                                "Nitrogen Version, Allocation = 1" = "orange",
                                "Nitrogen Version, Allocation = 1.5" = "green",
                                "Nitrogen Version, Allocation = 2" = "blue",
                                "Numeric" = "black")) +
  theme_classic() +
  theme(strip.background = element_rect(color = "white", size = 1),
        legend.title = element_blank()) +
  facet_wrap(~variable, scales = "free")
```
## Formatted weekly response

```{r}
cols = c("ppfd", "a", "n_leaf", "gs", "jmax")
df <- dat[,cols] %>% melt("ppfd")
df_2 <- dat_2[,cols] %>% melt("ppfd")
df_1.5 <- dat_1.5[,cols] %>% melt("ppfd")
df_0.75 <- dat_0.75[,cols] %>% melt("ppfd")
#df_original.m <- dat_original[,cols] %>% melt("ppfd")
df_original.m <- dat_original[,cols[-3]] %>% melt("ppfd")

new_titles <- c(
  "ppfd" = "Photosynthetic Photon Flux Density (μmol m⁻² s⁻¹)",
  "a" = "Assimilation rate\n(A, μmol m⁻² s⁻¹)",
  "n_leaf" = "Nitrogen Content\nin Needle (g g-2)",
  "gs" = "Stomatal Conductance\n(gs, mol m⁻² s⁻¹)",
  "jmax" = "Jmax Parameter\n(Jmax, μmol m⁻² s⁻¹)"
)

ggplot() + 
  geom_line(data = df, aes(y = value, x = ppfd, color = "Nitrogen Version,\nInfrastructure = 1")) +
  geom_line(data = df_2, aes(y = value, x = ppfd, color = "Nitrogen Version,\nInfrastructure = 2")) +
  geom_line(data = df_1.5, aes(y = value, x = ppfd, color = "Nitrogen Version,\nInfrastructure = 1.5")) +
  geom_line(data = df_0.75, aes(y = value, x = ppfd, color = "Nitrogen Version,\nInfrastructure = 0.75")) +
  geom_line(data = df_original.m, aes(y = value, x = ppfd, color = "Numeric"), linetype="dotted") +
  scale_color_manual(values = c("Nitrogen Version,\nInfrastructure = 0.75" = "red",
                                "Nitrogen Version,\nInfrastructure = 1" = "orange",
                                "Nitrogen Version,\nInfrastructure = 1.5" = "green",
                                "Nitrogen Version,\nInfrastructure = 2" = "blue",
                                "Numeric" = "black")) +
  theme_classic() +
  theme(strip.background = element_rect(color = "white", size = 1),
        legend.title = element_text(face = "bold"),
        strip.text = element_text(size = 10, face = "bold"),
        axis.title.y = element_blank(),
        plot.title = element_text(hjust = 0, face = "bold")) +  # Added this line for the figure label
  labs(color = "Model Versions and\nInfrastructure Value",
       x = "Photosynthetic Photon Flux Density, (μmol m⁻² s⁻¹)") +  # Added the figure label here
  facet_wrap(~variable, scales = "free", labeller = labeller(variable = new_titles))
```

## Instantaneous Response

```{r}
allocation = 1.0
acc = dat %>% filter(ppfd == 1200)
dat_inst = tibble(ppfd = seq(1,1200,length.out=50)) %>% mutate(dat = purrr::map(.x=ppfd, .f = ~rphydro_instantaneous_nitrogen(acc$vcmax25, acc$jmax25, tc, tc, .x, netrad, vpd, co2, pa, nitrogen, fapar, kphio, psi_soil, rdark, vwind, a_jmax, par_plant, list(alpha=0.1, gamma=1, carbon_allocation = allocation), options))) %>% unnest_wider(dat)

allocation = 0.75
acc_0.75 = dat_0.75 %>% filter(ppfd == 1200)
dat_inst_0.75 = tibble(ppfd = seq(1,1200,length.out=50)) %>% mutate(dat_0.75 = purrr::map(.x=ppfd, .f = ~rphydro_instantaneous_nitrogen(acc_0.75$vcmax25, acc_0.75$jmax25, tc, tc, .x, netrad, vpd, co2, pa, nitrogen, fapar, kphio, psi_soil, rdark, vwind, a_jmax, par_plant, list(alpha=0.1, gamma=1, carbon_allocation = allocation), options))) %>% unnest_wider(dat_0.75)

allocation = 1.5
acc_1.5 = dat_1.5 %>% filter(ppfd == 1200)
dat_inst_1.5 = tibble(ppfd = seq(1,1200,length.out=50)) %>% mutate(dat_1.5 = purrr::map(.x=ppfd, .f = ~rphydro_instantaneous_nitrogen(acc_1.5$vcmax25, acc_1.5$jmax25, tc, tc, .x, netrad, vpd, co2, pa, nitrogen, fapar, kphio, psi_soil, rdark, vwind, a_jmax, par_plant, list(alpha=0.1, gamma=1, carbon_allocation = allocation), options))) %>% unnest_wider(dat_1.5)

allocation = 2.0
acc_2 = dat_2 %>% filter(ppfd == 1200)
dat_inst_2 = tibble(ppfd = seq(1,1200,length.out=50)) %>% mutate(dat_2 = purrr::map(.x=ppfd, .f = ~rphydro_instantaneous_nitrogen(acc_2$vcmax25, acc_2$jmax25, tc, tc, .x, netrad, vpd, co2, pa, nitrogen, fapar, kphio, psi_soil, rdark, vwind, a_jmax, par_plant, list(alpha=0.1, gamma=1, carbon_allocation = allocation), options))) %>% unnest_wider(dat_2)

acc_original = dat_original %>% filter(ppfd == 1200)
dat_inst_original = tibble(ppfd = seq(1,1200,length.out=50)) %>% mutate(acc_original = purrr::map(.x=ppfd, .f = ~rphydro_instantaneous_numerical(acc_original$vcmax25, acc_original$jmax25, tc, tc, .x, netrad, vpd, co2, pa, fapar, kphio, psi_soil, rdark, vwind, par_plant, list(alpha=0.1, gamma=1), options))) %>% unnest_wider(acc_original)

df_inst_0.75 <- dat_inst_0.75 %>% melt("ppfd")
df_inst <- dat_inst %>% melt("ppfd")
df_inst_1.5 <- dat_inst_1.5 %>% melt("ppfd")
df_inst_2 <- dat_inst_2 %>% melt("ppfd")
df_original.m.inst <- dat_inst_original %>% melt("ppfd")

ggplot() + 
  geom_line(data = df_inst_0.75, aes(y = value, x = ppfd, color = "Nitrogen Version, Allocation = 0.75")) +
  geom_line(data = df_inst, aes(y = value, x = ppfd, color = "Nitrogen Version, Allocation = 1.0")) +
  geom_line(data = df_inst_1.5, aes(y = value, x = ppfd, color = "Nitrogen Version, Allocation = 1.5")) +
  geom_line(data = df_inst_2, aes(y = value, x = ppfd, color = "Nitrogen Version, Allocation = 2.0")) +
  geom_line(data = df_original.m.inst, aes(y = value, x = ppfd, color = "Numeric"), linetype="dotted") +
  scale_color_manual(values = c("Nitrogen Version, Allocation = 0.75" = "red", 
                                "Nitrogen Version, Allocation = 1.0" = "orange", 
                                "Nitrogen Version, Allocation = 1.5" = "green", 
                                "Nitrogen Version, Allocation = 2.0" = "blue", 
                                "Numeric" = "black")) +
  theme_classic() +
  theme(strip.background = element_rect(color = "white", size = 1),
        legend.title = element_blank()) +
  facet_wrap(~variable, scales = "free")
```

### Compare ac, aj, in inst responses - TODO: check formula

```{r}
par(mfrow = c(1, 2))
dat_inst %>% select(ac, aj, isVcmaxLimited) %>% mutate(isVcmaxLimited = isVcmaxLimited*5) %>%  matplot(x=dat_inst$ppfd, type="l", lty=1, col=c("green4", "yellow3", "black"), main = "Nitrogen Instant", xlab = "ppfd")
abline(v=0, col="pink")
dat_inst_original %>% select(ac, aj, isVcmaxLimited) %>% mutate(isVcmaxLimited = isVcmaxLimited*5) %>%  matplot(x=dat_inst_original$ppfd, type="l", lty=2, col=c("green4", "yellow3", "black"), main = "Original Instant", xlab = "ppfd")
abline(v=0, col="pink")
```

### J Behaviour

```{r}
J_n = tibble(ppfd = seq(0,1200, length.out=50)) %>% 
  mutate(J = kphio*ppfd/sqrt(1+(4*kphio*ppfd/(acc$n_leaf * a_jmax))^2))
J_n_0.75 = tibble(ppfd = seq(0,1200, length.out=50)) %>% 
  mutate(J = kphio*ppfd/sqrt(1+(4*kphio*ppfd/(acc_0.75$n_leaf * a_jmax))^2))
J_n_1.5 = tibble(ppfd = seq(0,1200, length.out=50)) %>% 
  mutate(J = kphio*ppfd/sqrt(1+(4*kphio*ppfd/(acc_1.5$n_leaf * a_jmax))^2))
J_n_2 = tibble(ppfd = seq(0,1200, length.out=50)) %>% 
  mutate(J = kphio*ppfd/sqrt(1+(4*kphio*ppfd/(acc_2$n_leaf * a_jmax))^2))

J_original = tibble(ppfd = seq(0,1200, length.out=50)) %>% 
  mutate(J = kphio*ppfd/sqrt(1+(4*kphio*ppfd/(acc_original$jmax))^2))

ggplot() +
  geom_line(data = J_n, aes(x = ppfd, y = J, color = "Nitrogen Version, Allocation = 1.0")) +
  geom_line(data = J_n_0.75, aes(x = ppfd, y = J, color = "Nitrogen Version, Allocation = 0.75")) +
  geom_line(data = J_n_1.5, aes(x = ppfd, y = J, color = "Nitrogen Version, Allocation = 1.5")) +
  geom_line(data = J_n_2, aes(x = ppfd, y = J, color = "Nitrogen Version, Allocation = 2.0")) +
  geom_line(data = J_original, aes(x = ppfd, y = J, color = "Numeric"), linetype="dotted") +
  scale_color_manual(values = c("Nitrogen Version, Allocation = 0.75" = "red", 
                                "Nitrogen Version, Allocation = 1.0" = "orange", 
                                "Nitrogen Version, Allocation = 1.5" = "green", 
                                "Nitrogen Version, Allocation = 2.0" = "blue", 
                                "Numeric" = "black")) +
  labs(x = "PPFD (mol m^-2 s^-1)", y = "J (mol m^-2 s^-1)", 
       title = "Electron Transport Rate (J) vs. PPFD")
```

### Testing parameters

```{r}
dat_carb_allocation = tibble(carb_allocation = seq(0.01, 2, length.out=100)) %>% mutate(dat = purrr::map(.x = carb_allocation, .f = ~rphydro_nitrogen(tc, tc, ppfd, netrad, vpd, co2, pa, nitrogen, fapar, kphio, psi_soil, rdark, vwind, a_jmax, par_plant, list(alpha=0.1, gamma=1, carbon_allocation = .x), options))) %>% unnest_wider(dat)

df_carb_allocation <- dat_carb_allocation %>% melt("carb_allocation")

ggplot(df_carb_allocation, aes(y=value, x=carb_allocation)) + 
  geom_line(col="aquamarine4") + 
  theme_classic() +
  theme(strip.background = element_rect(color = "white", size = 1)) +
  facet_wrap(~variable, scales = "free")
```

## Formatted weekly response

```{r}
cols = c("carb_allocation", "a", "n_leaf", "gs", "jmax")
df_carb_allocation <- dat_carb_allocation[,cols] %>% melt("carb_allocation")

new_titles <- c(
  "carb_allocation" = "Infrastructure",
  "a" = "Assimilation rate\n(A, μmol m⁻² s⁻¹)",
  "n_leaf" = "Nitrogen Content\nin Needle (g g-1)",
  "gs" = "Stomatal Conductance\n(gs, mol m⁻² s⁻¹)",
  "jmax" = "Jmax Parameter\n(Jmax, μmol m⁻² s⁻¹)"
)

ggplot(df_carb_allocation, aes(y=value, x=carb_allocation)) + 
  geom_line(col="aquamarine4") + 
  theme_classic() +
  theme(strip.background = element_rect(color = "white", size = 1),
        legend.title = element_text(face = "bold"),
        strip.text = element_text(size = 10, face = "bold"),
        axis.title.y = element_blank(),
        plot.title = element_text(hjust = 0, face = "bold")) +  # Added this line for the figure label
  labs(x = expression(paste("Infrastructure Parameter I"[b]))) +
  facet_wrap(~variable, scales = "free", labeller = labeller(variable = new_titles))
```


```{r}
dat_a_jmax = tibble(a_jmax = seq(80,8000,length.out=300)) %>% mutate(dat = purrr::map(.x = a_jmax, .f = ~rphydro_nitrogen(tc, tc, ppfd, netrad, vpd, co2, pa, nitrogen, fapar, kphio, psi_soil, rdark, vwind, .x, par_plant, par_cost, options))) %>% unnest_wider(dat)

df_ajmax <- dat_a_jmax %>% melt("a_jmax")

ggplot(df_ajmax, aes(y=value, x=a_jmax)) + 
  geom_line(col="aquamarine4") + 
  theme_classic() +
  theme(strip.background = element_rect(color = "white", size = 1))+
  facet_wrap(~variable, scales = "free")
```

```{r}
dat_alpha = tibble(alpha = seq(0.001,0.2,length.out=50)) %>% mutate(dat = purrr::map(.x = alpha, .f = ~rphydro_nitrogen(tc, tc, ppfd, netrad, vpd, co2, pa, nitrogen, fapar, kphio, psi_soil, rdark, vwind, a_jmax, par_plant, list(alpha=.x, gamma=1, carbon_allocation = 1), options))) %>% unnest_wider(dat)

df_alpha <- dat_alpha %>% melt("alpha")

ggplot(df_alpha, aes(y=value, x=alpha)) + 
  geom_line(col="aquamarine4") + 
  theme_classic() +
  theme(strip.background = element_rect(color = "white", size = 1))+
  facet_wrap(~variable, scales = "free")
```

## Nitrogen store effect!

```{r}

dat_nitrogen = tibble(nitrogen = seq(0.01,0.05,length.out=50)) %>% mutate(dat = purrr::map(.x = nitrogen, .f = ~rphydro_nitrogen(tc, tc, ppfd, netrad, vpd, co2, pa, .x, fapar, kphio, psi_soil, rdark, vwind, a_jmax, par_plant, par_cost, options))) %>% unnest_wider(dat)

cols = c("nitrogen", "a", "n_leaf", "gs", "jmax")
df_nitrogen <- dat_nitrogen[,cols] %>% melt("nitrogen")

new_titles <- c(
  "carb_allocation" = "Infrastructure",
  "a" = "Assimilation rate\n(A, μmol m⁻² s⁻¹)",
  "n_leaf" = "Nitrogen Content\nin Needle (g g-2)",
  "gs" = "Stomatal Conductance\n(gs, mol m⁻² s⁻¹)",
  "jmax" = "Jmax Parameter\n(Jmax, μmol m⁻² s⁻¹)"
)

ggplot(df_nitrogen, aes(y=value, x=nitrogen)) + 
  geom_line(col="aquamarine4") + 
  theme_classic() +
  theme(strip.background = element_rect(color = "white", size = 1),
        legend.title = element_text(face = "bold"),
        strip.text = element_text(size = 10, face = "bold"),
        axis.title.y = element_blank(),
        plot.title = element_text(hjust = 0, face = "bold")) +  # Added this line for the figure label
  labs(x = expression(paste("Leaf Nitrogen Store (g g-1)"))) +
  facet_wrap(~variable, scales = "free", labeller = labeller(variable = new_titles))
```


